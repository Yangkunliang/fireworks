<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å­¦ä¸€å¹´çº§å­¦ä¹ æ¸¸æˆ</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'å¾®è½¯é›…é»‘', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin: 10px 0 20px 0;
            font-size: clamp(20px, 5vw, 28px);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .game-container {
            width: 100%;
            max-width: 500px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            padding: 15px;
            backdrop-filter: blur(10px);
        }
        
        .setup-section, .game-section {
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        
        .stats div {
            text-align: center;
            padding: 4px;
        }
        
        .progress-container {
            height: 25px;
            background-color: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s ease-in-out;
            border-radius: 12px;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #333;
            font-weight: bold;
            font-size: 12px;
        }
        
        .falling-game-area {
            position: relative;
            height: 200px;
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            background: linear-gradient(180deg, #e3f2fd 0%, #bbdefb 100%);
            margin-bottom: 10px;
        }
        
        .falling-question {
            position: absolute;
            font-size: clamp(16px, 4vw, 20px);
            font-weight: bold;
            user-select: none;
            pointer-events: none;
            text-align: center;
            padding: 6px 10px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            color: #333;
            min-width: 50px;
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
            to { box-shadow: 0 4px 20px rgba(252, 182, 159, 0.6); }
        }
        
        .explosion {
            position: absolute;
            pointer-events: none;
            font-size: 30px;
            animation: explode 0.6s forwards;
            z-index: 100;
        }
        
        @keyframes explode {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            50% { transform: scale(2) rotate(180deg); opacity: 0.8; }
            100% { transform: scale(4) rotate(360deg); opacity: 0; }
        }
        
        /* è‡ªå®šä¹‰é”®ç›˜æ ·å¼ */
        .custom-keyboard {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .keyboard-title {
            text-align: center;
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .keyboard-grid {
            display: grid;
            gap: 8px;
        }
        
        .math-keyboard {
            grid-template-columns: repeat(5, 1fr);
        }
        
        .word-keyboard {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .keyboard-key {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 6px;
            font-size: clamp(14px, 3.5vw, 16px);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            user-select: none;
        }
        
        .keyboard-key:hover, .keyboard-key:active {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .keyboard-key:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .keyboard-key.correct {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            animation: correctPulse 0.6s ease-in-out;
        }
        
        .keyboard-key.wrong {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            animation: wrongShake 0.6s ease-in-out;
        }
        
        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
        
        @keyframes wrongShake {
            0%, 20%, 40%, 60%, 80%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
        }
        
        .current-answer {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 10px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .answer-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .clear-btn, .submit-btn {
            flex: 1;
            padding: 12px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .clear-btn {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .clear-btn:hover, .clear-btn:active {
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
            transform: translateY(-1px);
        }
        
        .submit-btn:hover, .submit-btn:active {
            background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
            transform: translateY(-1px);
        }
        
        .clear-btn:disabled, .submit-btn:disabled {
            background: #adb5bd;
            cursor: not-allowed;
            transform: none;
        }
        
        .voice-btn {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            background: linear-gradient(135deg, #fd7e14 0%, #e83e8c 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .voice-btn:hover, .voice-btn:active {
            background: linear-gradient(135deg, #e83e8c 0%, #fd7e14 100%);
            transform: translateY(-1px);
        }
        
        .voice-btn.listening {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .voice-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }
        
        button {
            padding: 12px 20px;
            font-size: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            min-height: 44px;
        }
        
        button:hover, button:active {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        select, input[type="number"] {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: white;
            transition: border-color 0.3s ease;
        }
        
        select:focus, input[type="number"]:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .difficulty-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        .message {
            text-align: center;
            font-weight: bold;
            min-height: 25px;
            margin: 10px 0;
            font-size: 14px;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .game-container {
                padding: 10px;
                border-radius: 10px;
            }
            
            .stats {
                font-size: 11px;
                padding: 8px;
            }
            
            .falling-game-area {
                height: 160px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .controls button {
                margin-bottom: 5px;
            }
            
            .keyboard-key {
                padding: 10px 4px;
                font-size: clamp(12px, 3vw, 14px);
                min-height: 40px;
            }
            
            .math-keyboard {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* é˜²æ­¢iOSç¼©æ”¾ */
        @media screen and (max-device-width: 480px) {
            select, textarea, input[type="text"], input[type="password"], input[type="datetime"], input[type="datetime-local"], input[type="date"], input[type="month"], input[type="time"], input[type="week"], input[type="number"], input[type="email"], input[type="url"], input[type="search"], input[type="tel"], input[type="color"] {
                font-size: 16px;
            }
        }
        
        .floating-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            z-index: 1000;
            pointer-events: none;
            animation: feedbackPop 1.5s forwards;
        }
        
        @keyframes feedbackPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }
    </style>
</head>
<body>

<div class="game-container">
    <h1>ğŸ® å°å­¦ä¸€å¹´çº§å­¦ä¹ æ¸¸æˆ</h1>

    <!-- æ¸¸æˆè®¾ç½®åŒºåŸŸ -->
    <div class="setup-section" id="setupSection">
        <div class="form-group">
            <label for="subjectSelect">ğŸ“š é€‰æ‹©ç§‘ç›®:</label>
            <select id="subjectSelect">
                <option value="math">æ•°å­¦ ğŸ”¢</option>
                <option value="chinese">è¯­æ–‡ ğŸ®</option>
                <option value="english">è‹±è¯­ ğŸŒ</option>
            </select>
        </div>

        <div class="form-group">
            <label for="difficultySelect">âš¡ é€‰æ‹©éš¾åº¦:</label>
            <select id="difficultySelect">
                <option value="easy">ç®€å• (è¶…æ…¢é€Ÿ, ç®€å•é¢˜ç›®)</option>
                <option value="medium" selected>ä¸­ç­‰ (æ…¢é€Ÿ, ä¸­ç­‰é¢˜ç›®)</option>
                <option value="hard">å›°éš¾ (é€‚ä¸­é€Ÿåº¦, å›°éš¾é¢˜ç›®)</option>
            </select>
            <div class="difficulty-info" id="difficultyInfo">é€Ÿåº¦: æ…¢é€Ÿ | é¢˜ç›®éš¾åº¦: ä¸­ç­‰</div>
        </div>

        <div class="form-group">
            <label for="questionCountInput">ğŸ“ é¢˜ç›®æ•°é‡ (5-50):</label>
            <input type="number" id="questionCountInput" min="5" max="50" value="10">
        </div>

        <button id="startGameBtn">ğŸš€ å¼€å§‹æ¸¸æˆ</button>
    </div>

    <!-- æ¸¸æˆè¿›è¡ŒåŒºåŸŸ -->
    <div class="game-section" id="gameSection" style="display: none;">
        <div class="stats">
            <div>ğŸ“Š æ€»é¢˜æ•°: <span id="totalCount">0</span></div>
            <div>âœ… ç­”å¯¹: <span id="correctCount">0</span></div>
            <div>âŒ ç­”é”™: <span id="wrongCount">0</span></div>
            <div>â³ æœªç­”: <span id="unansweredCount">0</span></div>
        </div>

        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
            <div class="progress-text" id="progressText">0%</div>
        </div>

        <!-- æ–‡å­—å¿«æ‰“æ¨¡å¼åŒºåŸŸ -->
        <div class="falling-game-area" id="fallingGameArea">
            <!-- ä¸‹è½çš„é¢˜ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- å½“å‰ç­”æ¡ˆæ˜¾ç¤º -->
        <div class="current-answer" id="currentAnswer">å‡†å¤‡è¾“å…¥ç­”æ¡ˆ...</div>

        <!-- è‡ªå®šä¹‰é”®ç›˜ -->
        <div class="custom-keyboard" id="customKeyboard">
            <div class="keyboard-title" id="keyboardTitle">æ•°å­—é”®ç›˜</div>
            <div class="keyboard-grid" id="keyboardGrid">
                <!-- é”®ç›˜æŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ç­”æ¡ˆæ§åˆ¶æŒ‰é’® -->
        <div class="answer-controls">
            <button class="clear-btn" id="clearBtn">ğŸ—‘ï¸ æ¸…ç©º</button>
            <button class="submit-btn" id="submitBtn">âœ… æäº¤</button>
        </div>

        <!-- è¯­éŸ³è¾“å…¥æŒ‰é’® -->
        <button class="voice-btn" id="voiceBtn" title="å¼€å§‹/åœæ­¢è¯­éŸ³è¯†åˆ«">ğŸ¤ è¯­éŸ³è¾“å…¥</button>

        <div class="message" id="message"></div>

        <div class="controls">
            <button id="pauseResumeBtn">â¸ï¸ æš‚åœ</button>
            <button id="endGameBtn">ğŸ ç»“æŸæ¸¸æˆ</button>
        </div>
    </div>
</div>

<script>
    // éŸ³æ•ˆç³»ç»Ÿ
    class SoundManager {
        constructor() {
            this.context = null;
            this.enabled = true;
            this.init();
        }
        
        async init() {
            try {
                this.context = new (window.AudioContext || window.webkitAudioContext)();
                document.addEventListener('click', () => {
                    if (this.context && this.context.state === 'suspended') {
                        this.context.resume();
                    }
                }, { once: true });
            } catch (e) {
                console.warn('éŸ³é¢‘ä¸æ”¯æŒ:', e);
                this.enabled = false;
            }
        }
        
        playCorrectSound() {
            if (!this.enabled || !this.context) return;
            this.playTone([523.25, 659.25, 783.99], 0.3, 'sine');
        }
        
        playWrongSound() {
            if (!this.enabled || !this.context) return;
            this.playTone([220, 196], 0.5, 'sawtooth');
        }
        
        playGameEndSound() {
            if (!this.enabled || !this.context) return;
            const notes = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25];
            notes.forEach((freq, i) => {
                setTimeout(() => this.playTone([freq], 0.2, 'sine'), i * 100);
            });
        }
        
        playTone(frequencies, duration, waveType = 'sine') {
            if (!this.context) return;
            
            const gainNode = this.context.createGain();
            gainNode.connect(this.context.destination);
            gainNode.gain.setValueAtTime(0, this.context.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.1, this.context.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + duration);
            
            frequencies.forEach(freq => {
                const oscillator = this.context.createOscillator();
                oscillator.connect(gainNode);
                oscillator.frequency.setValueAtTime(freq, this.context.currentTime);
                oscillator.type = waveType;
                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + duration);
            });
        }
    }

    // åé¦ˆç³»ç»Ÿ
    class FeedbackManager {
        static showFloatingFeedback(message, type = 'success') {
            const existing = document.querySelector('.floating-feedback');
            if (existing) existing.remove();
            
            const feedback = document.createElement('div');
            feedback.className = 'floating-feedback';
            feedback.textContent = message;
            feedback.style.background = type === 'success' ? 
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' :
                'linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)';
            
            document.body.appendChild(feedback);
            setTimeout(() => feedback.remove(), 1500);
        }
    }

    // --- æ¸¸æˆæ•°æ®å’ŒçŠ¶æ€ ---
    const gameData = {
        math: {
            easy: { speed: 0.3, range: 5, ops: ['+'], generateFreq: 0.006 },
            medium: { speed: 0.5, range: 10, ops: ['+', '-'], generateFreq: 0.01 },
            hard: { speed: 0.8, range: 20, ops: ['+', '-', '*'], generateFreq: 0.015 }
        },
        chinese: {
            easy: { 
                speed: 0.3, 
                generateFreq: 0.006,
                words: ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹','å','äºº','å¤§','å°','ä¸Š','ä¸‹'] 
            },
            medium: { 
                speed: 0.5, 
                generateFreq: 0.01,
                words: ['ä½ å¥½','ä¸–ç•Œ','å­¦ä¹ ','å¿«ä¹','é˜³å…‰','èŠ±æœµ','å°é¸Ÿ','ä¹¦æœ¬','è€å¸ˆ','å­¦ç”Ÿ','å­¦æ ¡','æœ‹å‹','å®¶åº­','çˆ¸çˆ¸','å¦ˆå¦ˆ'] 
            },
            hard: { 
                speed: 0.8, 
                generateFreq: 0.015,
                words: ['å­¦æ ¡','è€å¸ˆ','å­¦ç”Ÿ','æœ‹å‹','å®¶åº­','çˆ¸çˆ¸','å¦ˆå¦ˆ','çˆ·çˆ·','å¥¶å¥¶','å“¥å“¥','å§å§','å¼Ÿå¼Ÿ','å¦¹å¦¹','æ—©ä¸Š','æ™šä¸Š'] 
            }
        },
        english: {
            easy: { 
                speed: 0.3, 
                generateFreq: 0.006,
                words: ['cat','dog','red','blue','one','two','sun','moon','star','car'] 
            },
            medium: { 
                speed: 0.5, 
                generateFreq: 0.01,
                words: ['apple','banana','school','book','teacher','student','happy','sad','big','small','run','jump','sing','dance','play'] 
            },
            hard: { 
                speed: 0.8, 
                generateFreq: 0.015,
                words: ['school','teacher','student','friend','family','father','mother','brother','sister','morning','evening','good','nice','new','old'] 
            }
        }
    };

    let gameState = {
        subject: 'math',
        difficulty: 'medium',
        totalQuestions: 10,
        currentQuestionIndex: 0,
        correctAnswers: 0,
        wrongAnswers: 0,
        unansweredQuestions: 0,
        fallingQuestions: [],
        gameActive: false,
        gamePaused: false,
        animationId: null,
        gameAreaHeight: 0,
        gameAreaWidth: 0,
        currentAnswer: ''
    };

    // åˆå§‹åŒ–éŸ³æ•ˆå’Œåé¦ˆç®¡ç†å™¨
    const soundManager = new SoundManager();

    // --- DOM å…ƒç´  ---
    const setupSection = document.getElementById('setupSection');
    const gameSection = document.getElementById('gameSection');
    const subjectSelect = document.getElementById('subjectSelect');
    const difficultySelect = document.getElementById('difficultySelect');
    const difficultyInfo = document.getElementById('difficultyInfo');
    const questionCountInput = document.getElementById('questionCountInput');
    const startGameBtn = document.getElementById('startGameBtn');

    const totalCountEl = document.getElementById('totalCount');
    const correctCountEl = document.getElementById('correctCount');
    const wrongCountEl = document.getElementById('wrongCount');
    const unansweredCountEl = document.getElementById('unansweredCount');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    const fallingGameArea = document.getElementById('fallingGameArea');
    const currentAnswerEl = document.getElementById('currentAnswer');
    const customKeyboard = document.getElementById('customKeyboard');
    const keyboardTitle = document.getElementById('keyboardTitle');
    const keyboardGrid = document.getElementById('keyboardGrid');
    const clearBtn = document.getElementById('clearBtn');
    const submitBtn = document.getElementById('submitBtn');
    const voiceBtn = document.getElementById('voiceBtn');
    const messageEl = document.getElementById('message');

    const pauseResumeBtn = document.getElementById('pauseResumeBtn');
    const endGameBtn = document.getElementById('endGameBtn');

    // --- é”®ç›˜ç”Ÿæˆå‡½æ•° ---
    function generateMathKeyboard() {
        keyboardTitle.textContent = 'æ•°å­—é”®ç›˜';
        keyboardGrid.className = 'keyboard-grid math-keyboard';
        keyboardGrid.innerHTML = '';
        
        // æ•°å­— 0-9 å’Œåˆ é™¤ã€æäº¤æŒ‰é’®
        const keys = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'];
        
        keys.forEach(key => {
            const keyBtn = document.createElement('button');
            keyBtn.className = 'keyboard-key';
            keyBtn.textContent = key;
            keyBtn.addEventListener('click', () => addToAnswer(key));
            keyboardGrid.appendChild(keyBtn);
        });
    }

    function generateWordKeyboard(words) {
        const subject = gameState.subject;
        keyboardTitle.textContent = subject === 'chinese' ? 'ä¸­æ–‡é”®ç›˜' : 'è‹±æ–‡é”®ç›˜';
        keyboardGrid.className = 'keyboard-grid word-keyboard';
        keyboardGrid.innerHTML = '';
        
        // éšæœºé€‰æ‹©ä¸€äº›è¯æ±‡ä½œä¸ºé€‰é¡¹ï¼ŒåŒ…å«æ­£ç¡®ç­”æ¡ˆ
        const keyOptions = [...new Set(words)].slice(0, 15); // å»é‡å¹¶é™åˆ¶æ•°é‡
        
        // æ‰“ä¹±é¡ºåº
        for (let i = keyOptions.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [keyOptions[i], keyOptions[j]] = [keyOptions[j], keyOptions[i]];
        }
        
        keyOptions.forEach(word => {
            const keyBtn = document.createElement('button');
            keyBtn.className = 'keyboard-key';
            keyBtn.textContent = word;
            keyBtn.addEventListener('click', () => selectWordAnswer(word));
            keyboardGrid.appendChild(keyBtn);
        });
    }

    function addToAnswer(char) {
        if (gameState.currentAnswer.length < 10) {
            gameState.currentAnswer += char;
            updateAnswerDisplay();
        }
    }

    function selectWordAnswer(word) {
        gameState.currentAnswer = word;
        updateAnswerDisplay();
        // è‡ªåŠ¨æäº¤è¯æ±‡ç­”æ¡ˆ
        setTimeout(() => submitAnswer(), 100);
    }

    function clearAnswer() {
        gameState.currentAnswer = '';
        updateAnswerDisplay();
        resetKeyboardStyles();
    }

    function updateAnswerDisplay() {
        currentAnswerEl.textContent = gameState.currentAnswer || 'å‡†å¤‡è¾“å…¥ç­”æ¡ˆ...';
    }

    function resetKeyboardStyles() {
        document.querySelectorAll('.keyboard-key').forEach(key => {
            key.classList.remove('correct', 'wrong');
        });
    }

    // --- è¯­éŸ³è¯†åˆ«ç›¸å…³ ---
    let recognition;
    let isListening = false;

    function initSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            console.warn("æµè§ˆå™¨ä¸æ”¯æŒ Web Speech API");
            voiceBtn.disabled = true;
            voiceBtn.innerHTML = "ğŸš« ä¸æ”¯æŒè¯­éŸ³";
            return;
        }

        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'zh-CN'; 

        recognition.onstart = () => {
            isListening = true;
            voiceBtn.classList.add('listening');
            voiceBtn.innerHTML = 'ğŸ›‘ åœæ­¢è¯­éŸ³';
            showMessage("æ­£åœ¨è†å¬...", 'info');
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript.trim().toLowerCase();
            showMessage(`å¬åˆ°: ${transcript}`, 'info');
            gameState.currentAnswer = transcript;
            updateAnswerDisplay();
            setTimeout(() => submitAnswer(), 500);
            stopListening();
        };

        recognition.onerror = (event) => {
            console.error("è¯­éŸ³è¯†åˆ«é”™è¯¯:", event.error);
            showMessage(`è¯†åˆ«é”™è¯¯: ${event.error}`, 'error');
            stopListening();
        };

        recognition.onend = () => {
            isListening = false;
            voiceBtn.classList.remove('listening');
            voiceBtn.innerHTML = 'ğŸ¤ è¯­éŸ³è¾“å…¥';
        };
    }

    function startListening() {
        if (recognition && !isListening && gameState.gameActive && !gameState.gamePaused) {
            try {
                if (gameState.subject === 'english') {
                    recognition.lang = 'en-US';
                } else {
                    recognition.lang = 'zh-CN';
                }
                recognition.start();
            } catch (e) {
                console.error("å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥:", e);
                showMessage("å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥", 'error');
            }
        }
    }

    function stopListening() {
        if (recognition && isListening) {
            try {
                recognition.stop();
            } catch (e) {
                console.error("åœæ­¢è¯­éŸ³è¯†åˆ«å¤±è´¥:", e);
            }
        }
    }

    // --- è¾…åŠ©å‡½æ•° ---
    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function generateMathQuestion(diffConfig) {
        const num1 = getRandomInt(1, diffConfig.range);
        const num2 = getRandomInt(1, diffConfig.range);
        
        if (diffConfig.ops.includes('*') && Math.random() < 0.3) {
            const smallNum1 = getRandomInt(1, 5);
            const smallNum2 = getRandomInt(1, 5);
            return { question: `${smallNum1} Ã— ${smallNum2}`, answer: (smallNum1 * smallNum2).toString() };
        } else if (diffConfig.ops.includes('-') && Math.random() > 0.5) {
            const maxNum = Math.max(num1, num2);
            const minNum = Math.min(num1, num2);
            return { question: `${maxNum} - ${minNum}`, answer: (maxNum - minNum).toString() };
        } else {
            return { question: `${num1} + ${num2}`, answer: (num1 + num2).toString() };
        }
    }

    function generateWordQuestion(diffConfig) {
        if (diffConfig.words && diffConfig.words.length > 0) {
            const randomIndex = getRandomInt(0, diffConfig.words.length - 1);
            const word = diffConfig.words[randomIndex];
            return { question: word, answer: word.toLowerCase() };
        }
        return { question: "æ— ", answer: "æ— " };
    }

    function createFallingQuestionElement(questionObj) {
        const questionEl = document.createElement('div');
        questionEl.className = 'falling-question';
        questionEl.textContent = questionObj.question;
        
        const maxLeftPos = gameState.gameAreaWidth - 80;
        const leftPos = Math.max(10, Math.min(maxLeftPos, getRandomInt(10, maxLeftPos)));
        questionEl.style.left = `${leftPos}px`;
        questionEl.style.top = '-50px';
        questionEl.dataset.answer = questionObj.answer;
        questionEl.dataset.processed = "false";
        return questionEl;
    }

    function createExplosionElement(x, y, isCorrect = true) {
        const explosionEl = document.createElement('div');
        explosionEl.className = 'explosion';
        explosionEl.textContent = isCorrect ? 'ğŸ‰' : 'ğŸ’¥';
        explosionEl.style.left = `${x}px`;
        explosionEl.style.top = `${y}px`;
        return explosionEl;
    }

    function showMessage(text, type = 'info') {
        messageEl.textContent = text;
        messageEl.className = `message ${type}`;
        setTimeout(() => {
            if (messageEl.textContent === text) {
                messageEl.textContent = '';
                messageEl.className = 'message';
            }
        }, type === 'error' ? 3000 : 2000);
    }

    // --- æ¸¸æˆé€»è¾‘å‡½æ•° ---
    function updateStats() {
        totalCountEl.textContent = gameState.totalQuestions;
        correctCountEl.textContent = gameState.correctAnswers;
        wrongCountEl.textContent = gameState.wrongAnswers;
        gameState.unansweredQuestions = gameState.totalQuestions - gameState.currentQuestionIndex;
        unansweredCountEl.textContent = gameState.unansweredQuestions;

        const progressPercent = (gameState.currentQuestionIndex / gameState.totalQuestions) * 100;
        progressBar.style.width = `${progressPercent}%`;
        progressText.textContent = `${Math.round(progressPercent)}%`;
    }

    function submitAnswer() {
        const userInput = gameState.currentAnswer.trim().toLowerCase();
        if (!userInput) {
            showMessage("è¯·å…ˆè¾“å…¥ç­”æ¡ˆ! ğŸ“", 'error');
            return;
        }

        let targetQuestion = null;
        let targetIndex = -1;
        let lowestTop = -1;

        gameState.fallingQuestions.forEach((qEl, index) => {
            if (qEl.dataset.processed === "false") {
                const top = parseFloat(qEl.style.top) || 0;
                if (top > lowestTop) {
                    lowestTop = top;
                    targetQuestion = qEl;
                    targetIndex = index;
                }
            }
        });

        if (targetQuestion) {
            const correctAnswer = targetQuestion.dataset.answer;
            const isCorrect = userInput === correctAnswer;
            
            if (isCorrect) {
                gameState.correctAnswers++;
                soundManager.playCorrectSound();
                
                // æ˜¾ç¤ºæ­£ç¡®æŒ‰é”®æ•ˆæœ
                if (gameState.subject === 'math') {
                    document.querySelectorAll('.keyboard-key').forEach(key => {
                        if (key.textContent === gameState.currentAnswer) {
                            key.classList.add('correct');
                        }
                    });
                } else {
                    document.querySelectorAll('.keyboard-key').forEach(key => {
                        if (key.textContent.toLowerCase() === correctAnswer) {
                            key.classList.add('correct');
                        }
                    });
                }
                
                const rect = targetQuestion.getBoundingClientRect();
                const areaRect = fallingGameArea.getBoundingClientRect();
                const explosionX = rect.left - areaRect.left + rect.width / 2;
                const explosionY = rect.top - areaRect.top + rect.height / 2;
                const explosion = createExplosionElement(explosionX, explosionY, true);
                fallingGameArea.appendChild(explosion);
                
                setTimeout(() => {
                    if (explosion.parentNode) {
                        explosion.remove();
                    }
                }, 600);

                targetQuestion.dataset.processed = "true";
                targetQuestion.remove();
                gameState.fallingQuestions.splice(targetIndex, 1);
                updateStats();
                
                const encouragements = ["å¤ªæ£’äº†! ğŸ‰", "ç­”å¯¹äº†! â­", "å¾ˆå‰å®³! ğŸ‘", "ç»§ç»­åŠ æ²¹! ğŸ’ª", "çœŸèªæ˜! ğŸ§ "];
                const randomEncouragement = encouragements[Math.floor(Math.random() * encouragements.length)];
                showMessage(randomEncouragement, 'success');
                FeedbackManager.showFloatingFeedback(randomEncouragement, 'success');
                
            } else {
                soundManager.playWrongSound();
                
                // æ˜¾ç¤ºé”™è¯¯æŒ‰é”®æ•ˆæœ
                if (gameState.subject === 'math') {
                    document.querySelectorAll('.keyboard-key').forEach(key => {
                        if (key.textContent === gameState.currentAnswer) {
                            key.classList.add('wrong');
                        }
                    });
                } else {
                    document.querySelectorAll('.keyboard-key').forEach(key => {
                        if (key.textContent.toLowerCase() === userInput) {
                            key.classList.add('wrong');
                        }
                    });
                }
                
                const sadMessages = ["å†è¯•è¯•çœ‹! ğŸ¤”", "åŠ æ²¹ï¼Œä½ å¯ä»¥çš„! ğŸ’ª", "æ²¡å…³ç³»ï¼Œç»§ç»­åŠªåŠ›! ğŸ˜Š"];
                const randomSadMessage = sadMessages[Math.floor(Math.random() * sadMessages.length)];
                showMessage(`${randomSadMessage} æ­£ç¡®ç­”æ¡ˆ: ${correctAnswer}`, 'error');
            }
        } else {
            showMessage("æ²¡æœ‰å¯å›ç­”çš„é¢˜ç›® ğŸ¤·â€â™€ï¸", 'info');
        }
        
        // æ¸…ç©ºå½“å‰ç­”æ¡ˆå¹¶é‡ç½®æ ·å¼
        setTimeout(() => {
            clearAnswer();
        }, 1000);
    }

    function gameLoop() {
        if (gameState.gamePaused || !gameState.gameActive) return;

        // ç”Ÿæˆæ–°é¢˜ç›®é€»è¾‘
        if (gameState.currentQuestionIndex < gameState.totalQuestions) {
            const diffConfig = gameData[gameState.subject][gameState.difficulty];
            if (Math.random() < diffConfig.generateFreq) {
                let newQuestionObj;
                if (gameState.subject === 'math') {
                    newQuestionObj = generateMathQuestion(diffConfig);
                } else {
                    newQuestionObj = generateWordQuestion(diffConfig);
                }
                const questionEl = createFallingQuestionElement(newQuestionObj);
                fallingGameArea.appendChild(questionEl);
                gameState.fallingQuestions.push(questionEl);
                gameState.currentQuestionIndex++;
                updateStats();
            }
        }

        // ç§»åŠ¨æ‰€æœ‰æœªè¢«å¤„ç†çš„ä¸‹è½é¢˜ç›®
        const speed = gameData[gameState.subject][gameState.difficulty].speed;
        for (let i = gameState.fallingQuestions.length - 1; i >= 0; i--) {
            const qEl = gameState.fallingQuestions[i];
            if (qEl.dataset.processed === "false") {
                const currentTop = parseFloat(qEl.style.top) || 0;
                const newTop = currentTop + speed;
                qEl.style.top = `${newTop}px`;

                // æ£€æŸ¥æ˜¯å¦è½åœ°
                if (newTop > gameState.gameAreaHeight) {
                    gameState.wrongAnswers++;
                    soundManager.playWrongSound();
                    
                    // æ˜¾ç¤ºè½åœ°æ•ˆæœ
                    const rect = qEl.getBoundingClientRect();
                    const areaRect = fallingGameArea.getBoundingClientRect();
                    const explosionX = rect.left - areaRect.left + rect.width / 2;
                    const explosionY = gameState.gameAreaHeight - 30;
                    const explosion = createExplosionElement(explosionX, explosionY, false);
                    fallingGameArea.appendChild(explosion);
                    
                    setTimeout(() => {
                        if (explosion.parentNode) {
                            explosion.remove();
                        }
                    }, 600);
                    
                    FeedbackManager.showFloatingFeedback(`é”™è¿‡äº†: ${qEl.textContent}`, 'error');
                    qEl.dataset.processed = "true";
                    qEl.remove();
                    gameState.fallingQuestions.splice(i, 1);
                    updateStats();
                }
            }
        }

        // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
        if (gameState.currentQuestionIndex >= gameState.totalQuestions && 
            gameState.fallingQuestions.filter(q => q.dataset.processed === "false").length === 0) {
            endGame();
            return;
        }

        gameState.animationId = requestAnimationFrame(gameLoop);
    }

    function startGame() {
        // é‡ç½®æ¸¸æˆçŠ¶æ€
        gameState.subject = subjectSelect.value;
        gameState.difficulty = difficultySelect.value;
        gameState.totalQuestions = parseInt(questionCountInput.value) || 10;
        gameState.totalQuestions = Math.max(5, Math.min(50, gameState.totalQuestions));
        gameState.currentQuestionIndex = 0;
        gameState.correctAnswers = 0;
        gameState.wrongAnswers = 0;
        gameState.unansweredQuestions = gameState.totalQuestions;
        gameState.gameActive = true;
        gameState.gamePaused = false;
        gameState.fallingQuestions = [];
        gameState.currentAnswer = '';

        // æ¸…ç©ºæ¸¸æˆåŒºåŸŸå’Œæ¶ˆæ¯
        fallingGameArea.innerHTML = '';
        messageEl.textContent = '';
        messageEl.className = 'message';
        clearAnswer();

        // ç”Ÿæˆå¯¹åº”çš„é”®ç›˜
        if (gameState.subject === 'math') {
            generateMathKeyboard();
        } else {
            const diffConfig = gameData[gameState.subject][gameState.difficulty];
            generateWordKeyboard(diffConfig.words);
        }

        // æ›´æ–°UI
        setupSection.style.display = 'none';
        gameSection.style.display = 'block';
        pauseResumeBtn.innerHTML = 'â¸ï¸ æš‚åœ';
        
        clearBtn.disabled = false;
        submitBtn.disabled = false;
        voiceBtn.disabled = false;

        gameState.gameAreaHeight = fallingGameArea.clientHeight;
        gameState.gameAreaWidth = fallingGameArea.clientWidth;

        updateStats();
        
        if (gameState.animationId) {
            cancelAnimationFrame(gameState.animationId);
        }
        
        // æ˜¾ç¤ºå¼€å§‹æç¤º
        FeedbackManager.showFloatingFeedback('æ¸¸æˆå¼€å§‹! ğŸš€', 'success');
        gameLoop();
    }

    function pauseGame() {
        gameState.gamePaused = true;
        pauseResumeBtn.innerHTML = 'â–¶ï¸ ç»§ç»­';
        clearBtn.disabled = true;
        submitBtn.disabled = true;
        stopListening();
        voiceBtn.disabled = true;
        
        // ç¦ç”¨é”®ç›˜
        document.querySelectorAll('.keyboard-key').forEach(key => {
            key.disabled = true;
        });
        
        cancelAnimationFrame(gameState.animationId);
        showMessage("æ¸¸æˆå·²æš‚åœ â¸ï¸", 'info');
    }

    function resumeGame() {
        gameState.gamePaused = false;
        pauseResumeBtn.innerHTML = 'â¸ï¸ æš‚åœ';
        clearBtn.disabled = false;
        submitBtn.disabled = false;
        voiceBtn.disabled = false;
        
        // å¯ç”¨é”®ç›˜
        document.querySelectorAll('.keyboard-key').forEach(key => {
            key.disabled = false;
        });
        
        showMessage("æ¸¸æˆç»§ç»­! ğŸ®", 'success');
        gameLoop();
    }

    function endGame() {
        gameState.gameActive = false;
        gameState.gamePaused = true;
        cancelAnimationFrame(gameState.animationId);
        clearBtn.disabled = true;
        submitBtn.disabled = true;
        stopListening();
        voiceBtn.disabled = true;
        
        // ç¦ç”¨é”®ç›˜
        document.querySelectorAll('.keyboard-key').forEach(key => {
            key.disabled = true;
        });
        
        updateStats();
        const totalAnswered = gameState.correctAnswers + gameState.wrongAnswers;
        const finalUnanswered = gameState.totalQuestions - totalAnswered;
        unansweredCountEl.textContent = finalUnanswered;

        soundManager.playGameEndSound();
        
        const accuracy = totalAnswered > 0 ? Math.round((gameState.correctAnswers / totalAnswered) * 100) : 0;
        let performance = '';
        if (accuracy >= 90) performance = 'ğŸ† å¤ªæ£’äº†ï¼';
        else if (accuracy >= 70) performance = 'ğŸ‘ å¾ˆä¸é”™ï¼';
        else if (accuracy >= 50) performance = 'ğŸ’ª ç»§ç»­åŠªåŠ›ï¼';
        else performance = 'ğŸŒŸ åŠ æ²¹ç»ƒä¹ ï¼';
        
        const gameOverMsg = `ğŸ‰ æ¸¸æˆç»“æŸï¼${performance}\n\nğŸ“Š æˆç»©ç»Ÿè®¡ï¼š\næ€»é¢˜æ•°: ${gameState.totalQuestions}\nâœ… ç­”å¯¹: ${gameState.correctAnswers}\nâŒ ç­”é”™: ${gameState.wrongAnswers}\nâ³ æœªç­”: ${finalUnanswered}\nğŸ¯ å‡†ç¡®ç‡: ${accuracy}%`;
        
        setTimeout(() => {
            alert(gameOverMsg);
            setupSection.style.display = 'block';
            gameSection.style.display = 'none';
        }, 500);
    }

    // --- äº‹ä»¶ç›‘å¬å™¨ ---
    startGameBtn.addEventListener('click', startGame);

    clearBtn.addEventListener('click', clearAnswer);
    submitBtn.addEventListener('click', submitAnswer);

    voiceBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (isListening) {
            stopListening();
        } else {
            startListening();
        }
    });

    pauseResumeBtn.addEventListener('click', () => {
        if (gameState.gamePaused) {
            resumeGame();
        } else {
            pauseGame();
        }
    });

    endGameBtn.addEventListener('click', () => {
        if (confirm('ç¡®å®šè¦ç»“æŸå½“å‰æ¸¸æˆå—ï¼Ÿ ğŸ¤”')) {
            endGame();
        }
    });

    difficultySelect.addEventListener('change', () => {
        const diff = difficultySelect.value;
        const infoMap = {
            'easy': 'é€Ÿåº¦: è¶…æ…¢é€Ÿ | é¢˜ç›®éš¾åº¦: ç®€å•',
            'medium': 'é€Ÿåº¦: æ…¢é€Ÿ | é¢˜ç›®éš¾åº¦: ä¸­ç­‰',
            'hard': 'é€Ÿåº¦: é€‚ä¸­é€Ÿåº¦ | é¢˜ç›®éš¾åº¦: å›°éš¾'
        };
        difficultyInfo.textContent = infoMap[diff] || '';
    });

    // é˜²æ­¢é¡µé¢æ»šåŠ¨å’Œç¼©æ”¾
    document.addEventListener('touchmove', function(e) {
        e.preventDefault();
    }, { passive: false });

    // é˜»æ­¢åŒå‡»ç¼©æ”¾
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(e) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            e.preventDefault();
        }
        lastTouchEnd = now;
    }, false);

    // åˆå§‹åŒ–
    window.addEventListener('load', () => {
        initSpeechRecognition();
        difficultySelect.dispatchEvent(new Event('change'));
        updateAnswerDisplay();
        
        // é¢„çƒ­éŸ³é¢‘ä¸Šä¸‹æ–‡
        document.addEventListener('click', () => {
            if (soundManager.context && soundManager.context.state === 'suspended') {
                soundManager.context.resume();
            }
        }, { once: true });
    });

    // å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–
    document.addEventListener('visibilitychange', () => {
        if (document.hidden && gameState.gameActive && !gameState.gamePaused) {
            pauseGame();
        }
    });
</script>

</body>
</html>
